import numpy as np  # เพิ่มการ import numpy
from ultralytics import YOLO
from PIL import Image
import pytesseract
import re

# ตั้งค่าตัวแปร tesseract_cmd ให้ชี้ไปที่ `tesseract.exe` ที่ติดตั้งในเครื่อง
pytesseract.pytesseract.tesseract_cmd = r'C:\Program Files\Tesseract-OCR\tesseract.exe'  # ตั้งตามที่ติดตั้ง Tesseract

# โหลดโมเดล YOLOv8 ที่เทรนแล้ว
model = YOLO('D:/projectCPE/dataset/yolov8n.pt')  # ระบุเส้นทางที่ไฟล์โมเดลถูกเก็บไว้

# ตรวจจับในภาพ
results = model('D:/projectCPE/dataset/images/test/test3.jpg')  # ระบุเส้นทางของภาพที่ต้องการตรวจจับ

# แสดงผลลัพธ์จากผลการตรวจจับในภาพแรก (หรือในภาพที่ต้องการ)
results[0].plot()  # ใช้ plot() แทน show() เพื่อแสดงภาพที่ตรวจจับแล้ว

# ใช้ to_df() เพื่อแปลงข้อมูลผลลัพธ์มาเป็น DataFrame จากแต่ละ Result object
df = results[0].to_df()  # ดึงข้อมูลจากผลลัพธ์ที่ 1 (แรก) เป็น DataFrame

# แสดงข้อมูลของ bounding boxes, confidence และ labels
print(df)

# ดึงข้อมูล bounding boxes, confidence, และ class labels
boxes = df['box'].values  # ข้อมูล bounding boxes ที่เป็น dictionary
confidences = df['confidence'].values  # ค่า confidence ของการตรวจจับ
labels = df['name'].values  # ชื่อของวัตถุที่ตรวจจับได้

# คำนวณค่าตำแหน่งกลาง (center) และขนาด (width, height) จากค่า bounding boxes
calculated_boxes = []
for box in boxes:
    x1, y1, x2, y2 = box['x1'], box['y1'], box['x2'], box['y2']
    x_center = (x1 + x2) / 2
    y_center = (y1 + y2) / 2
    width = x2 - x1
    height = y2 - y1
    calculated_boxes.append([x_center, y_center, width, height])

# แปลง calculated_boxes ให้เป็น numpy array
calculated_boxes = np.array(calculated_boxes)

# จัดเรียง bounding boxes ตามตำแหน่ง X (ซ้ายไปขวา)
sorted_boxes = sorted(zip(calculated_boxes, confidences), key=lambda x: x[0][0])  # x[0][0] คือค่าของ X ของ bounding box

# ดึงข้อมูลจาก sorted_boxes
sorted_positions = [box[0] for box in sorted_boxes]
sorted_confidences = [box[1] for box in sorted_boxes]

# ใช้ PIL เพื่อเปิดภาพจากเส้นทางที่ให้ไว้ (ใช้ผลลัพธ์ที่ได้จาก YOLO)
img = Image.open('D:/projectCPE/dataset/images/test/test3.jpg')  # แทนที่ด้วยเส้นทางที่ถูกต้องของไฟล์

# ตัดภาพตามตำแหน่งที่ระบุ
cropped_images = []
for box in sorted_positions:
    x1, y1, x2, y2 = map(int, box)  # แปลงเป็น integer
    
    # ตรวจสอบค่าพิกัดเพื่อไม่ให้เกิดการข้ามกัน
    if x1 > x2:  # ถ้า x1 มากกว่า x2 ให้สลับค่า
        x1, x2 = x2, x1
    if y1 > y2:  # ถ้า y1 มากกว่า y2 ให้สลับค่า
        y1, y2 = y2, y1

    # ตัดภาพ
    cropped_image = img.crop((x1, y1, x2, y2))
    cropped_images.append(cropped_image)

    # แสดงภาพที่ตัดออกมา
    cropped_image.show()  # แสดงภาพที่ตัดแล้ว

    # หรือบันทึกภาพที่ตัดออกมา
    cropped_image.save(f"cropped_image_{x1}_{y1}.png")  # บันทึกภาพที่ตัดออกมา

# ใช้ OCR บนภาพที่ตัดออกมา
text_numbers = []
for cropped_image in cropped_images:
    text = pytesseract.image_to_string(cropped_image, config='--psm 6')  # PSM 6 ใช้ในการตรวจจับบรรทัดเดียว
    text_numbers.append(text.strip())  # เก็บตัวเลขที่ตรวจจับได้

# ทำความสะอาดผลลัพธ์ OCR เพื่อให้ได้ตัวเลขที่ถูกต้อง
cleaned_numbers = []
for text in text_numbers:
    # กรองเฉพาะตัวเลขที่ถูกต้อง
    cleaned_text = re.sub(r'\D', '', text)  # ลบทุกอย่างที่ไม่ใช่ตัวเลข
    cleaned_numbers.append(cleaned_text)

# แสดงผลตัวเลขที่ทำความสะอาดแล้ว
print("ตัวเลขที่ตรวจจับได้:", cleaned_numbers)
